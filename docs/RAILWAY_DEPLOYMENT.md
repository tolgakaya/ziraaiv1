# Railway Deployment Guide for ZiraAI

## Overview
This guide explains how to configure and deploy ZiraAI on Railway with proper environment variable management and Docker build configuration for monorepo structure.

## Docker Configuration for Monorepo

### Build Configuration
Railway requires specific configuration for building multiple services from a monorepo:

#### Required Environment Variables for Each Service:

**Worker Service:**
```bash
RAILWAY_DOCKERFILE_PATH=Dockerfile.worker
```

**WebAPI Service:**
```bash
RAILWAY_DOCKERFILE_PATH=Dockerfile.webapi
```

### File Structure
```
ziraai/
‚îú‚îÄ‚îÄ Dockerfile.worker          # Worker service Dockerfile (at root)
‚îú‚îÄ‚îÄ Dockerfile.webapi          # WebAPI Dockerfile (at root)
‚îú‚îÄ‚îÄ railway.json               # Root Railway config
‚îú‚îÄ‚îÄ PlantAnalysisWorkerService/
‚îÇ   ‚îî‚îÄ‚îÄ railway.json          # Service-specific deployment config
‚îî‚îÄ‚îÄ WebAPI/
    ‚îî‚îÄ‚îÄ railway.json          # Service-specific deployment config
```

### Important Notes:
- **Dockerfiles must be at repository root** for access to all project dependencies
- **Root Directory in Railway Settings must be empty** (use repository root as build context)
- **RAILWAY_DOCKERFILE_PATH** tells Railway which Dockerfile to use for each service

## Railway Environment Variables Setup

### Method 1: Using Railway Dashboard (Recommended)

1. **Navigate to your Railway project**
2. **Click on the service (e.g., ziraai-staging)**
3. **Go to Variables tab**
4. **Choose RAW Editor or Form mode**

### Method 2: Using Railway CLI

```bash
railway login
railway link
railway variables set KEY=value
```

## Required Environment Variables

### üîê Database Configuration
```bash
# Railway provides DATABASE_URL automatically for PostgreSQL
# But we need it in .NET format:
DATABASE_CONNECTION_STRING="Host=postgres.railway.internal;Port=5432;Database=railway;Username=postgres;Password=<auto-generated>;SSL Mode=Require;Trust Server Certificate=true"

# Alternative: Use Railway's DATABASE_URL and convert it in code
DATABASE_URL="postgresql://postgres:password@postgres.railway.internal:5432/railway"
```

### üîë Application Security
```bash
ASPNETCORE_ENVIRONMENT="Staging"  # or "Production"
JWT_SECRET_KEY="your-super-secret-key-minimum-32-characters-long"
JWT_ISSUER="ZiraAI_Production"
JWT_AUDIENCE="ZiraAI_Production_Users"
```

### üì® RabbitMQ Configuration
```bash
# For Railway-hosted RabbitMQ
RABBITMQ_CONNECTION="amqp://user:pass@rabbitmq.railway.internal:5672/"

# For external RabbitMQ (CloudAMQP)
RABBITMQ_CONNECTION="amqp://user:pass@hostname.cloudamqp.com/vhost"
```

### üíæ Redis Configuration
```bash
# For Railway Redis
REDIS_HOST="redis.railway.internal"
REDIS_PORT="6379"
REDIS_PASSWORD="your-redis-password"

# Or as connection string
REDIS_CONNECTION="redis.railway.internal:6379,password=your-password"
```

### ü§ñ N8N Integration
```bash
N8N_WEBHOOK_URL="https://your-n8n-instance.com/webhook/api/plant-analysis"
N8N_API_KEY="your-n8n-api-key"
```

### üìÅ File Storage
```bash
FILE_STORAGE_PROVIDER="FreeImageHost"  # or "ImgBB", "S3"

# For FreeImageHost
FREEIMAGEHOST_API_KEY="6d207e02198a847aa98d0a2a901485a5"

# For ImgBB
IMGBB_API_KEY="your-imgbb-api-key"

# For S3
S3_BUCKET_NAME="ziraai-images"
S3_REGION="us-east-1"
S3_ACCESS_KEY="your-access-key"
S3_SECRET_KEY="your-secret-key"
```

### üìß Email Configuration
```bash
SMTP_HOST="smtp.sendgrid.net"
SMTP_PORT="587"
SMTP_USE_SSL="true"
SMTP_USERNAME="apikey"
SMTP_PASSWORD="your-sendgrid-api-key"
EMAIL_FROM="noreply@ziraai.com"
```

### üîß Additional Settings
```bash
# Logging
LOG_LEVEL="Information"  # Debug, Information, Warning, Error
LOG_TO_FILE="false"  # Railway handles logging

# Feature Flags
ENABLE_SWAGGER="false"  # Disable in production
ENABLE_HANGFIRE_DASHBOARD="false"  # Disable in production
ENABLE_DEBUG_MODE="false"
ENABLE_DETAILED_ERRORS="false"

# Performance
MAX_REQUEST_SIZE="52428800"  # 50MB
REQUEST_TIMEOUT="300000"  # 5 minutes
```

## Environment-Specific Configurations

### Development Environment
```bash
ASPNETCORE_ENVIRONMENT=Development
ENABLE_SWAGGER=true
ENABLE_DEBUG_MODE=true
LOG_LEVEL=Debug
```

### Staging Environment
```bash
ASPNETCORE_ENVIRONMENT=Staging
ENABLE_SWAGGER=true
ENABLE_DEBUG_MODE=false
LOG_LEVEL=Information
```

### Production Environment
```bash
ASPNETCORE_ENVIRONMENT=Production
ENABLE_SWAGGER=false
ENABLE_DEBUG_MODE=false
LOG_LEVEL=Warning
```

## Railway Service Configuration

### PostgreSQL Database
Railway automatically provides:
- `DATABASE_URL` - Connection string in URL format
- `PGDATABASE` - Database name
- `PGHOST` - Host address
- `PGPASSWORD` - Password
- `PGPORT` - Port number
- `PGUSER` - Username

### Converting Railway DATABASE_URL to .NET Format

Railway provides `DATABASE_URL` in this format:
```
postgresql://user:password@host:port/database
```

For .NET, we need:
```
Host=host;Port=port;Database=database;Username=user;Password=password;SSL Mode=Require;
```

## Deployment Process

### 1. Configure Docker Build (IMPORTANT - Do this first!)

#### For Worker Service:
1. Go to Railway Dashboard
2. Select PlantAnalysisWorkerService
3. Go to **Variables** tab
4. Add: `RAILWAY_DOCKERFILE_PATH=Dockerfile.worker`
5. Go to **Settings** tab
6. Ensure **Root Directory** is empty (not set)

#### For WebAPI Service:
1. Go to Railway Dashboard
2. Select WebAPI service
3. Go to **Variables** tab
4. Add: `RAILWAY_DOCKERFILE_PATH=Dockerfile.webapi`
5. Go to **Settings** tab
6. Ensure **Root Directory** is empty (not set)

### 2. Initial Setup
```bash
# Link your GitHub repository
railway login
railway link
railway up
```

### 3. Configure Watch Paths (Optional but Recommended)
To prevent unnecessary rebuilds when unrelated files change:

**Worker Service Watch Paths:**
```
PlantAnalysisWorkerService/**
Business/**
Core/**
DataAccess/**
Entities/**
```

**WebAPI Watch Paths:**
```
WebAPI/**
Business/**
Core/**
DataAccess/**
Entities/**
```

Set these in Railway Dashboard > Service > Settings > Watch Paths

### 4. Set Environment Variables
```bash
# Set all required variables
railway variables set ASPNETCORE_ENVIRONMENT=Staging
railway variables set JWT_SECRET_KEY="your-secret-key"
# ... add all other variables
```

### 5. Deploy
```bash
# Manual deploy
railway up

# Or automatic deploy on push to branch
# Configure in Railway dashboard: Settings > Deploys
```

## Monitoring & Logs

### View Logs
```bash
railway logs
```

### In Railway Dashboard
1. Go to your service
2. Click on "Logs" tab
3. Filter by log level or search

## Troubleshooting

### Common Issues

#### 1. Docker Build Fails - "Core/Core.csproj not found"
**Cause:** Railway is using wrong build context
**Solution:**
- Ensure `RAILWAY_DOCKERFILE_PATH` environment variable is set
- Verify Root Directory is empty in Railway Settings
- Dockerfiles must be at repository root
- Check that all project references use correct paths

#### 2. Database Connection Failed
- Check `DATABASE_CONNECTION_STRING` format
- Ensure SSL Mode is set to `Require`
- Verify Railway PostgreSQL is running

#### 3. Environment Variables Not Loading
- Check variable names (case-sensitive)
- Restart service after adding variables
- Verify in logs: "Using system environment variables"

#### 4. File Upload Issues
- Verify `FILE_STORAGE_PROVIDER` is set
- Check API keys for storage providers
- Ensure provider URLs are accessible

## Security Best Practices

1. **Never commit sensitive data**
   - Use Railway's environment variables
   - Keep `.env` files local only

2. **Use strong secrets**
   - JWT keys: minimum 32 characters
   - Passwords: use Railway's generated ones

3. **Limit access**
   - Use Railway's team features
   - Separate staging/production projects

4. **Monitor logs**
   - Check for security warnings
   - Review failed authentication attempts

## Useful Railway CLI Commands

```bash
# View all variables
railway variables

# Set multiple variables from file
railway variables set $(cat .env.production)

# Connect to database
railway connect postgres

# Open project in browser
railway open

# View deployment status
railway status
```

## Railway-Specific Files

### railway.json (Root)
```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "environments": {
    "production": {
      "build": {
        "builder": "DOCKERFILE"
      }
    },
    "staging": {
      "build": {
        "builder": "DOCKERFILE"
      }
    }
  }
}
```

### PlantAnalysisWorkerService/railway.json
```json
{
  "$schema": "https://railway.com/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE"
  },
  "deploy": {
    "startCommand": "dotnet PlantAnalysisWorkerService.dll",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

### WebAPI/railway.json
```json
{
  "$schema": "https://railway.com/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE"
  },
  "deploy": {
    "startCommand": "dotnet WebAPI.dll",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

## Support Resources

- [Railway Documentation](https://docs.railway.app)
- [Railway Discord](https://discord.gg/railway)
- [ZiraAI Repository](https://github.com/tolgakaya/ziraaiv1)