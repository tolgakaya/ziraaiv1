using Business.Services.ABTesting;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;
using System.Threading.Tasks;

namespace WebAPI.Controllers
{
    [Route("api/v{version:apiVersion}/[controller]")]
    [ApiController]
    [ApiVersion("1.0")]
    [Authorize(Roles = "Sponsor,Admin")]
    public class ABTestingController : BaseApiController
    {
        private readonly IABTestingService _abTestingService;

        public ABTestingController(IABTestingService abTestingService)
        {
            _abTestingService = abTestingService;
        }

        /// <summary>
        /// Create a new A/B test campaign with multiple message variants
        /// Supports statistical analysis, automated winner selection, and performance tracking
        /// </summary>
        [HttpPost("create")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status403Forbidden)]
        public async Task<IActionResult> CreateABTest([FromBody] CreateABTestRequest request)
        {
            try
            {
                var sponsorId = GetCurrentUserId();
                if (!sponsorId.HasValue)
                {
                    return Forbid("Sponsor ID bulunamadÄ±");
                }

                request.SponsorId = sponsorId.Value;
                var result = await _abTestingService.CreateABTestAsync(request);
                return result.Success ? Ok(result) : BadRequest(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"A/B test oluÅŸturulamadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Get details of a specific A/B test including real-time metrics
        /// </summary>
        [HttpGet("{testId}")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> GetABTest(string testId)
        {
            try
            {
                var result = await _abTestingService.GetABTestAsync(testId);
                return result.Success ? Ok(result) : NotFound(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"A/B test alÄ±namadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Get list of A/B tests for current sponsor with optional status filtering
        /// </summary>
        [HttpGet]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status403Forbidden)]
        public async Task<IActionResult> GetABTests([FromQuery] ABTestStatus? status = null)
        {
            try
            {
                var sponsorId = GetCurrentUserId();
                if (!sponsorId.HasValue)
                {
                    return Forbid("Sponsor ID bulunamadÄ±");
                }

                var result = await _abTestingService.GetABTestsAsync(sponsorId.Value, status);
                return result.Success ? Ok(result) : BadRequest(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"A/B testler alÄ±namadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Update A/B test configuration (only available for draft/scheduled tests)
        /// </summary>
        [HttpPut("{testId}")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> UpdateABTest(string testId, [FromBody] UpdateABTestRequest request)
        {
            try
            {
                var result = await _abTestingService.UpdateABTestAsync(testId, request);
                return result.Success ? Ok(result) : BadRequest(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"A/B test gÃ¼ncellenemedi: {ex.Message}" });
            }
        }

        /// <summary>
        /// Start an A/B test campaign
        /// </summary>
        [HttpPost("{testId}/start")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> StartABTest(string testId)
        {
            try
            {
                var result = await _abTestingService.StartABTestAsync(testId);
                return result.Success ? Ok(result) : BadRequest(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"A/B test baÅŸlatÄ±lamadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Pause a running A/B test
        /// </summary>
        [HttpPost("{testId}/pause")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> PauseABTest(string testId)
        {
            try
            {
                var result = await _abTestingService.PauseABTestAsync(testId);
                return result.Success ? Ok(result) : BadRequest(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"A/B test duraklatÄ±lamadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Stop an A/B test permanently
        /// </summary>
        [HttpPost("{testId}/stop")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> StopABTest(string testId)
        {
            try
            {
                var result = await _abTestingService.StopABTestAsync(testId);
                return result.Success ? Ok(result) : BadRequest(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"A/B test durdurulamadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Get comprehensive A/B test results with statistical analysis
        /// Includes winner determination, confidence intervals, and business impact
        /// </summary>
        [HttpGet("{testId}/results")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> GetABTestResults(string testId)
        {
            try
            {
                var result = await _abTestingService.GetABTestResultsAsync(testId);
                return result.Success ? Ok(result) : NotFound(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"A/B test sonuÃ§larÄ± alÄ±namadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Record an A/B test event (impression, click, conversion)
        /// Used by external systems to track user interactions
        /// </summary>
        [HttpPost("{testId}/events")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> RecordABTestEvent(string testId, [FromBody] ABTestEvent testEvent)
        {
            try
            {
                var result = await _abTestingService.RecordABTestEventAsync(testId, testEvent);
                return result.Success ? Ok(result) : BadRequest(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"Olay kaydedilemedi: {ex.Message}" });
            }
        }

        /// <summary>
        /// Get advanced insights and optimization suggestions for A/B test
        /// Includes trend analysis, audience insights, and channel performance
        /// </summary>
        [HttpGet("{testId}/insights")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> GetABTestInsights(string testId)
        {
            try
            {
                var result = await _abTestingService.GetABTestInsightsAsync(testId);
                return result.Success ? Ok(result) : NotFound(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"A/B test Ã¶ngÃ¶rÃ¼leri alÄ±namadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Get template variations and performance history for A/B test
        /// </summary>
        [HttpGet("{testId}/templates")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> GetTemplateVariations(string testId)
        {
            try
            {
                var result = await _abTestingService.GetTemplateVariationsAsync(testId);
                return result.Success ? Ok(result) : NotFound(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"Åablon varyasyonlarÄ± alÄ±namadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Manually declare a winner for A/B test
        /// </summary>
        [HttpPost("{testId}/declare-winner")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> DeclareWinner(string testId, [FromBody] DeclareWinnerRequest request)
        {
            try
            {
                var result = await _abTestingService.DeclareWinnerAsync(testId, request.VariantId);
                return result.Success ? Ok(result) : BadRequest(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"Kazanan belirlenemedi: {ex.Message}" });
            }
        }

        /// <summary>
        /// Get personalized optimization recommendations for sponsor
        /// Based on historical test performance and industry benchmarks
        /// </summary>
        [HttpGet("recommendations")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status403Forbidden)]
        public async Task<IActionResult> GetOptimizationRecommendations()
        {
            try
            {
                var sponsorId = GetCurrentUserId();
                if (!sponsorId.HasValue)
                {
                    return Forbid("Sponsor ID bulunamadÄ±");
                }

                var result = await _abTestingService.GetOptimizationRecommendationsAsync(sponsorId.Value);
                return result.Success ? Ok(result) : BadRequest(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"Optimizasyon Ã¶nerileri alÄ±namadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Get detailed statistical analysis for A/B test
        /// Includes power analysis, effect size, and confidence intervals
        /// </summary>
        [HttpGet("{testId}/statistics")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public async Task<IActionResult> GetTestStatistics(string testId)
        {
            try
            {
                var result = await _abTestingService.GetTestStatisticsAsync(testId);
                return result.Success ? Ok(result) : NotFound(result);
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"Test istatistikleri alÄ±namadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Get A/B testing best practices and guidelines
        /// </summary>
        [HttpGet("best-practices")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        public async Task<IActionResult> GetBestPractices()
        {
            try
            {
                var bestPractices = new
                {
                    test_design = new
                    {
                        title = "Test TasarÄ±mÄ±",
                        practices = new[]
                        {
                            new { practice = "Tek deÄŸiÅŸken testi", description = "Her testte sadece bir deÄŸiÅŸkeni test edin (mesaj tonu, gÃ¶nderim zamanÄ±, vb.)", importance = "critical" },
                            new { practice = "Kontrol grubu", description = "Her zaman mevcut en iyi performanslÄ± versiyonu kontrol grubu olarak kullanÄ±n", importance = "high" },
                            new { practice = "AnlamlÄ± fark", description = "En az %10 fark yaratabilecek deÄŸiÅŸiklikleri test edin", importance = "medium" },
                            new { practice = "Hedef belirle", description = "Testten Ã¶nce baÅŸarÄ± metriklerini net olarak tanÄ±mlayÄ±n", importance = "high" }
                        }
                    },
                    sample_size = new
                    {
                        title = "Ã–rneklem BÃ¼yÃ¼klÃ¼ÄŸÃ¼",
                        practices = new[]
                        {
                            new { practice = "Minimum Ã¶rneklem", description = "Ä°statistiksel anlamlÄ±lÄ±k iÃ§in varyant baÅŸÄ±na en az 100 katÄ±lÄ±mcÄ±", importance = "critical" },
                            new { practice = "Test sÃ¼resi", description = "GÃ¼venilir sonuÃ§lar iÃ§in en az 1 hafta test Ã§alÄ±ÅŸtÄ±rÄ±n", importance = "high" },
                            new { practice = "GÃ¼Ã§ analizi", description = "%80 istatistiksel gÃ¼Ã§ hedefleyin", importance = "medium" },
                            new { practice = "Erken sonlandÄ±rma", description = "AnlamlÄ± sonuÃ§lar Ã§Ä±ksa bile minimum test sÃ¼resini tamamlayÄ±n", importance = "medium" }
                        }
                    },
                    implementation = new
                    {
                        title = "Uygulama",
                        practices = new[]
                        {
                            new { practice = "Rastgele atama", description = "KatÄ±lÄ±mcÄ±larÄ± varyantlara rastgele atayÄ±n", importance = "critical" },
                            new { practice = "EÅŸ zamanlÄ± test", description = "TÃ¼m varyantlarÄ± aynÄ± zamanda Ã§alÄ±ÅŸtÄ±rÄ±n", importance = "high" },
                            new { practice = "DeÄŸiÅŸken kontrol", description = "Test sÄ±rasÄ±nda hiÃ§bir deÄŸiÅŸkeni deÄŸiÅŸtirmeyin", importance = "high" },
                            new { practice = "Veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼", description = "TÃ¼m etkileÅŸimleri doÄŸru ÅŸekilde takip edin", importance = "critical" }
                        }
                    },
                    analysis = new
                    {
                        title = "Analiz",
                        practices = new[]
                        {
                            new { practice = "Ä°statistiksel anlamlÄ±lÄ±k", description = "%95 gÃ¼ven aralÄ±ÄŸÄ±nÄ± hedefleyin", importance = "high" },
                            new { practice = "Pratik anlamlÄ±lÄ±k", description = "Ä°statistiksel anlamlÄ±lÄ±ÄŸÄ±n yanÄ±nda iÅŸ etkisini de deÄŸerlendirin", importance = "medium" },
                            new { practice = "Segment analizi", description = "SonuÃ§larÄ± farklÄ± kullanÄ±cÄ± segmentlerine gÃ¶re inceleyin", importance = "medium" },
                            new { practice = "Tekrar test", description = "Ã–nemli sonuÃ§larÄ± farklÄ± Ã¶rneklemlerle doÄŸrulayÄ±n", importance = "low" }
                        }
                    },
                    common_mistakes = new
                    {
                        title = "YaygÄ±n Hatalar",
                        mistakes = new[]
                        {
                            new { mistake = "Erken sonlandÄ±rma", description = "Ä°lk olumlu sonuÃ§larÄ± gÃ¶rÃ¼nce testi erkenden durdurmak", solution = "Minimum test sÃ¼resini bekleyin" },
                            new { mistake = "Ã‡ok fazla varyant", description = "AynÄ± anda Ã§ok fazla varyant test etmek", solution = "Maksimum 3-4 varyant kullanÄ±n" },
                            new { mistake = "YanlÄ±ÅŸ metrik", description = "YanlÄ±ÅŸ baÅŸarÄ± metriÄŸi seÃ§mek", solution = "Ä°ÅŸ hedeflerinize uygun metrikleri seÃ§in" },
                            new { mistake = "Ã–rneklem bias'Ä±", description = "Belirli bir gruba odaklanmak", solution = "Hedef kitlenizi temsil eden Ã¶rneklem kullanÄ±n" }
                        }
                    },
                    agriculture_specific = new
                    {
                        title = "TarÄ±m SektÃ¶rÃ¼ne Ã–zel",
                        practices = new[]
                        {
                            new { practice = "Mevsimsel faktÃ¶rler", description = "TarÄ±m dÃ¶ngÃ¼sÃ¼nÃ¼ gÃ¶z Ã¶nÃ¼nde bulundurarak test planlayÄ±n", importance = "high" },
                            new { practice = "BÃ¶lgesel farklar", description = "FarklÄ± coÄŸrafi bÃ¶lgelerdeki Ã§iftÃ§i davranÄ±ÅŸlarÄ±nÄ± dikkate alÄ±n", importance = "medium" },
                            new { practice = "ÃœrÃ¼n dÃ¶ngÃ¼sÃ¼", description = "Ekim, bakÄ±m ve hasat dÃ¶nemlerine gÃ¶re mesaj iÃ§eriklerini test edin", importance = "medium" },
                            new { practice = "Teknoloji adaptasyonu", description = "Ã‡iftÃ§ilerin teknoloji kullanÄ±m seviyelerine gÃ¶re mesaj karmaÅŸÄ±klÄ±ÄŸÄ±nÄ± ayarlayÄ±n", importance = "high" }
                        }
                    }
                };

                return Ok(new { success = true, data = bestPractices });
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"En iyi uygulamalar alÄ±namadÄ±: {ex.Message}" });
            }
        }

        /// <summary>
        /// Get A/B testing templates library
        /// Pre-built message templates optimized for agriculture sector
        /// </summary>
        [HttpGet("template-library")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        public async Task<IActionResult> GetTemplateLibrary()
        {
            try
            {
                var templateLibrary = new
                {
                    categories = new[]
                    {
                        new
                        {
                            category = "message_tone",
                            name = "Mesaj Tonu",
                            description = "FarklÄ± iletiÅŸim tonlarÄ± ve yaklaÅŸÄ±mlarÄ±",
                            templates = new[]
                            {
                                new
                                {
                                    id = "friendly_casual",
                                    name = "Samimi ve Rahat",
                                    message = "Merhaba {name}! ğŸŒ± TarÄ±msal iÅŸlerinizde size yardÄ±m edebiliriz. Detaylar iÃ§in: {link}",
                                    tone = "informal",
                                    performance_hint = "GenÃ§ Ã§iftÃ§iler iÃ§in etkili"
                                },
                                new
                                {
                                    id = "professional_formal",
                                    name = "Profesyonel ve Resmi",
                                    message = "SayÄ±n {name}, tarÄ±msal verimliliÄŸinizi artÄ±rmak iÃ§in geliÅŸmiÅŸ Ã§Ã¶zÃ¼mlerimizi inceleyebilirsiniz: {link}",
                                    tone = "formal",
                                    performance_hint = "Deneyimli Ã§iftÃ§iler iÃ§in uygun"
                                },
                                new
                                {
                                    id = "expert_technical",
                                    name = "Uzman ve Teknik",
                                    message = "{name}, toprak analizi ve bitki besleme optimizasyonu iÃ§in bilimsel Ã§Ã¶zÃ¼mlerimiz: {link}",
                                    tone = "technical",
                                    performance_hint = "BÃ¼yÃ¼k Ã§iftlik sahipleri iÃ§in"
                                }
                            }
                        },
                        new
                        {
                            category = "value_proposition",
                            name = "DeÄŸer Ã–nerisi",
                            description = "FarklÄ± fayda ve deÄŸer vurgularÄ±",
                            templates = new[]
                            {
                                new
                                {
                                    id = "cost_savings",
                                    name = "Maliyet Tasarrufu",
                                    message = "{name}, tarÄ±msal maliyetlerinizi %30'a kadar azaltabilirsiniz. Ãœcretsiz analiz: {link}",
                                    value_type = "cost_reduction",
                                    performance_hint = "Ekonomik zorluk yaÅŸayan Ã§iftÃ§iler iÃ§in"
                                },
                                new
                                {
                                    id = "yield_increase",
                                    name = "Verim ArtÄ±ÅŸÄ±",
                                    message = "Merhaba {name}, Ã¼rÃ¼n veriminizi %40'a kadar artÄ±rÄ±n. NasÄ±l mÄ±? {link}",
                                    value_type = "productivity",
                                    performance_hint = "BÃ¼yÃ¼me odaklÄ± Ã§iftÃ§iler iÃ§in"
                                },
                                new
                                {
                                    id = "time_saving",
                                    name = "Zaman Tasarrufu",
                                    message = "{name}, gÃ¼nde 3 saat zaman kazanÄ±n. AkÄ±llÄ± tarÄ±m Ã§Ã¶zÃ¼mleri: {link}",
                                    value_type = "efficiency",
                                    performance_hint = "YoÄŸun Ã§alÄ±ÅŸan Ã§iftÃ§iler iÃ§in"
                                }
                            }
                        },
                        new
                        {
                            category = "urgency_scarcity",
                            name = "Aciliyet ve KÄ±tlÄ±k",
                            description = "Harekete geÃ§irici aciliyet mesajlarÄ±",
                            templates = new[]
                            {
                                new
                                {
                                    id = "limited_time",
                                    name = "SÄ±nÄ±rlÄ± Zaman",
                                    message = "{name}, bu hafta sonu bitiyor! Ãœcretsiz analiz fÄ±rsatÄ±: {link}",
                                    urgency_type = "time_limited",
                                    performance_hint = "KÄ±sa vadeli kampanyalar iÃ§in"
                                },
                                new
                                {
                                    id = "seasonal_timing",
                                    name = "Mevsimsel Zamanlama",
                                    message = "Ekim sezonu yaklaÅŸÄ±yor {name}! Toprak analizinizi hemen yaptÄ±rÄ±n: {link}",
                                    urgency_type = "seasonal",
                                    performance_hint = "Mevsimsel operasyonlar iÃ§in"
                                }
                            }
                        }
                    },
                    usage_guidelines = new
                    {
                        title = "KullanÄ±m Rehberi",
                        guidelines = new[]
                        {
                            "Her kategoriden en fazla 1 template seÃ§in",
                            "Hedef kitlenize uygun tonu seÃ§in",
                            "A/B testinde maksimum 3 varyant kullanÄ±n",
                            "ÅablonlarÄ± kendi mesajÄ±nÄ±za uyarlayÄ±n",
                            "SonuÃ§lara gÃ¶re gelecekteki testleri planlayÄ±n"
                        }
                    },
                    personalization_variables = new[]
                    {
                        new { variable = "{name}", description = "Ã‡iftÃ§inin adÄ±", required = true },
                        new { variable = "{link}", description = "Sponsorluk linki", required = true },
                        new { variable = "{crop_type}", description = "ÃœrÃ¼n tÃ¼rÃ¼", required = false },
                        new { variable = "{location}", description = "BÃ¶lge bilgisi", required = false },
                        new { variable = "{season}", description = "Mevsim bilgisi", required = false }
                    }
                };

                return Ok(new { success = true, data = templateLibrary });
            }
            catch (System.Exception ex)
            {
                return BadRequest(new { success = false, message = $"Åablon kÃ¼tÃ¼phanesi alÄ±namadÄ±: {ex.Message}" });
            }
        }

        #region Private Helper Methods

        private int? GetCurrentUserId()
        {
            var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);
            if (int.TryParse(userIdClaim?.Value, out int userId))
            {
                return userId;
            }
            return null;
        }

        #endregion
    }

    #region Request/Response Models

    public class DeclareWinnerRequest
    {
        public string VariantId { get; set; }
    }

    #endregion
}